IS_Meta =
DATATABLE(
    "AuditGroup", STRING,
    "Section", STRING,
    "LineType", STRING,
    "SortOrder", INTEGER,
    {
        { "Local Network Services", "Operating Revenues", "Revenue", 1 },
        { "Network Access Services", "Operating Revenues", "Revenue", 2 },
        { "Long Distance Services", "Operating Revenues", "Revenue", 3 },
        { "Internet, Sales and Other Services", "Operating Revenues", "Revenue", 4 },
        { "Miscellaneous Revenue", "Operating Revenues", "Revenue", 5 },
        { "Plant Specific Operations", "Operating Expenses", "Expense", 6 },
        { "Plant Nonspecific Operations", "Operating Expenses", "Expense", 7 },
        { "Cost of Long Distance Services", "Operating Expenses", "Expense", 8 },
        { "Cost of Internet, Sales and Other Services", "Operating Expenses", "Expense", 9 },
        { "Depreciation", "Operating Expenses", "Expense", 10 },
        { "Customer Operations", "Operating Expenses", "Expense", 11 },
        { "Corporate Operations", "Operating Expenses", "Expense", 12 },
        { "General Taxes", "Operating Expenses", "Expense", 13 },
        { "Interest and Dividend Income", "Other Income", "OtherIncome", 14 },
        { "Earnings from Equity Method Investments", "Other Income", "OtherIncome", 15 },
        { "Other, Net", "Other Income", "OtherIncome", 16 },
        { "Income Tax Expense", "Income Taxes", "Tax", 17 }
    }
)


-- transaction sign
NetAmount_Tel :=
SUM ( 'tblGL (Telephone)'[dblDebit] ) - SUM ( 'tblGL (Telephone)'[dblCredit] )

-- leaf value for the matrix; respects the Year slicer
IS Base (Tel) :=
[NetAmount_Tel]

-- section totals for the “bottom block”
IS Revenues (Tel) :=
CALCULATE ( [IS Base (Tel)], REMOVEFILTERS(tblAuditGroup), KEEPFILTERS( IS_Meta[LineType] = "Revenue" ) )

IS Expenses (Tel) :=
CALCULATE ( [IS Base (Tel)], REMOVEFILTERS(tblAuditGroup), KEEPFILTERS( IS_Meta[LineType] = "Expense" ) )

IS Other Income (Tel) :=
CALCULATE ( [IS Base (Tel)], REMOVEFILTERS(tblAuditGroup), KEEPFILTERS( IS_Meta[LineType] = "OtherIncome" ) )

IS Income Tax (Tel) :=
CALCULATE ( [IS Base (Tel)], REMOVEFILTERS(tblAuditGroup), KEEPFILTERS( IS_Meta[LineType] = "Tax" ) )

IS Equity Earnings (Tel) :=
CALCULATE ( [IS Base (Tel)], REMOVEFILTERS(tblAuditGroup),
            KEEPFILTERS( IS_Meta[AuditGroup] = "Equity Earnings of Subsidiary" ) )

-- audit-style calculations
IS Operating Margin (Tel) :=
[IS Revenues (Tel)] - [IS Expenses (Tel)]

IS Margins Before Income Taxes (Tel) :=
[IS Operating Margin (Tel)] + [IS Other Income (Tel)]

IS Margins Before Equity Loss of Subsidiary (Tel) :=
[IS Margins Before Income Taxes (Tel)] - [IS Income Tax (Tel)]

IS Net Margins (Tel) :=
[IS Margins Before Equity Loss of Subsidiary (Tel)] + [IS Equity Earnings (Tel)]


Label,Sort
Operating Margins,1
Margins Before Income Taxes,2
Income Tax Expense,3
Margins Before Equity Loss of Subsidiary,4
Equity Earnings of Subsidiary,5
Net Margins,6

IS BottomValues_Tel :=
VAR lbl = SELECTEDVALUE ( IS_BottomRows[Label] )
RETURN
SWITCH (
    lbl,
    "Operating Margins",                        [IS Operating Margin (Tel)],
    "Margins Before Income Taxes",              [IS Margins Before Income Taxes (Tel)],
    "Income Tax Expense",                       [IS Income Tax (Tel)],
    "Margins Before Equity Loss of Subsidiary", [IS Margins Before Equity Loss of Subsidiary (Tel)],
    "Equity Earnings of Subsidiary",            [IS Equity Earnings (Tel)],
    "Net Margins",                              [IS Net Margins (Tel)],
    BLANK()
)



Unified table


IS_DisplayRows =
UNION (
    SELECTCOLUMNS(
        IS_Meta,
        "RowType","Leaf",
        "Label",   IS_Meta[AuditGroup],
        "Sort",    IS_Meta[SortOrder]
    ),
    DATATABLE(
        "RowType", STRING, "Label", STRING, "Sort", INTEGER,
        {
            { "Calc","Operating Margins", 101 },
            { "Calc","Margins Before Income Taxes", 102 },
            { "Calc","Income Tax Expense", 103 },  -- show again in the bottom block
            { "Calc","Margins Before Equity Loss of Subsidiary", 104 },
            { "Calc","Equity Earnings of Subsidiary", 105 },      -- show again
            { "Calc","Net Margins", 106 }
        }
    )
)
IS Value_Tel =
VAR lbl = SELECTEDVALUE ( IS_DisplayRows[Label] )
VAR rowType = SELECTEDVALUE ( IS_DisplayRows[RowType] )
RETURN
SWITCH (
    TRUE(),
    rowType = "Leaf",                                  [IS Base_Tel],
    lbl = "Operating Margins",                        [IS Operating Margin_Tel],
    lbl = "Margins Before Income Taxes",              [IS Margins Before Income Taxes_Tel],
    lbl = "Income Tax Expense",                       [IS Income Tax_Tel],
    lbl = "Margins Before Equity Loss of Subsidiary", [IS Margins Before Equity Loss of Subsidiary_Tel],
    lbl = "Equity Earnings of Subsidiary",            [IS Equity Earnings_Tel],
    lbl = "Net Margins",                              [IS Net Margins_Tel],
    BLANK()
)

