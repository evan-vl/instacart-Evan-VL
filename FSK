FS_Meta =
DATATABLE (
    "Section", STRING,
    "AuditGroup", STRING,
    "Sort", INTEGER,
    {
        // ===== Balance Sheet Data =====
        { "Balance Sheet Data", "Property, plant and equipment", 101 },
        { "Balance Sheet Data", "Less accumulated depreciation", 102 },
        { "Balance Sheet Data", "Net property and equipment",    103 },
        { "Balance Sheet Data", "Investments",                   104 },
        { "Balance Sheet Data", "Current assets",                105 },
        { "Balance Sheet Data", "Noncurrent assets",             106 },
        { "Balance Sheet Data", "Total assets",                  107 },
        { "Balance Sheet Data", "Less current liabilities",      108 },
        { "Balance Sheet Data", "Less other long-term liabilities", 109 },
        { "Balance Sheet Data", "Equity",                        110 },

        // ===== Operating Data =====
        { "Operating Data", "Local network services",            201 },
        { "Operating Data", "Network access services",           202 },
        { "Operating Data", "Long distance services",            203 },
        { "Operating Data", "Internet, sales and other services",204 },
        { "Operating Data", "Miscellaneous",                     205 },
        { "Operating Data", "Total operating revenues",          206 },
        { "Operating Data", "Operating expenses",                207 },
        { "Operating Data", "Depreciation and amortization",     208 },
        { "Operating Data", "General taxes",                     209 },
        { "Operating Data", "Net operating margins",             210 },
        { "Operating Data", "Other income, net",                 211 },
        { "Operating Data", "Income tax expense (benefit)",      212 },
        { "Operating Data", "Net margins",                       213 },

        // ===== Ratios =====
        { "Ratios", "Net Margin Return on Average Net Telephone Plant", 301 }
    }
)

3 new

FS_NetPPE_Consol :=
VAR grossPPE =
    CALCULATE( [BS Display_Consol],
        BS_Meta[AuditGroup] IN {
            "Telephone Plant in Service","Internet Plant in Service","Plant - Other","Plant Under Construction"
        }
    )
VAR accum =
    CALCULATE( [BS Display_Consol], BS_Meta[AuditGroup] = "Less Accumulated Depreciation" )
RETURN grossPPE - accum


FS_ReturnOnAvgNetPlant_Consol :=
VAR net_end  = [FS_NetPPE_Consol]
VAR net_beg  = CALCULATE( [FS_NetPPE_Consol], DATEADD( tblDate[Date], -1, YEAR ) )
VAR avg_net  = DIVIDE( net_end + net_beg, 2 )
RETURN DIVIDE( [IS Net Margins_Consol], avg_net )


FS Value_Consol :=
SWITCH(
    SELECTEDVALUE( FS_Meta[AuditGroup] ),

    // ---- Balance Sheet Data (re-using BS Display_Consol) ----
    "Property, plant and equipment",
        CALCULATE( [BS Display_Consol],
            BS_Meta[AuditGroup] IN {
                "Telephone Plant in Service","Internet Plant in Service","Plant - Other","Plant Under Construction"
            }
        ),

    "Less accumulated depreciation",
        CALCULATE( [BS Display_Consol], BS_Meta[AuditGroup] = "Less Accumulated Depreciation" ),

    "Net property and equipment", [FS_NetPPE_Consol],

    "Investments",
        CALCULATE( [BS Display_Consol],
            BS_Meta[AuditGroup] IN { "Equity Method Investments","Equity Investments" }
        ),

    "Current assets",
        CALCULATE( [BS Display_Consol], BS_Meta[Subsection] = "Current Assets" ),

    "Noncurrent assets",
        CALCULATE( [BS Display_Consol], BS_Meta[AuditGroup] IN { "Prepayments (Non Current)","Deferred Charges" } ),

    "Total assets",
        CALCULATE( [BS Display_Consol], BS_Meta[Section] = "Assets" ),

    "Less current liabilities",
        CALCULATE( [BS Display_Consol], BS_Meta[Subsection] = "Current Liabilities" ),

    "Less other long-term liabilities",
        CALCULATE( [BS Display_Consol], BS_Meta[Subsection] = "Other Noncurrent Liabilities" ),

    "Equity",
        CALCULATE( [BS Display_Consol], BS_Meta[Section] = "Members' Equity" ),

    // ---- Operating Data (re-using IS measures) ----
    "Local network services",
        CALCULATE( [IS Base_Consol], IS_Meta[AuditGroup] = "Local Network Services" ),

    "Network access services",
        CALCULATE( [IS Base_Consol], IS_Meta[AuditGroup] = "Network Access Services" ),

    "Long distance services",
        CALCULATE( [IS Base_Consol], IS_Meta[AuditGroup] = "Long Distance Services" ),

    "Internet, sales and other services",
        CALCULATE( [IS Base_Consol], IS_Meta[AuditGroup] = "Internet, Sales and Other Services" ),

    "Miscellaneous",
        CALCULATE( [IS Base_Consol], IS_Meta[AuditGroup] = "Miscellaneous Revenue" ),

    "Total operating revenues", [IS Revenues_Consol],

    "Operating expenses",
        CALCULATE(
            [IS Base_Consol],
            IS_Meta[Section] = "Operating Expenses",
            IS_Meta[AuditGroup] <> "Depreciation",
            IS_Meta[AuditGroup] <> "General Taxes"
        ),

    "Depreciation and amortization",
        CALCULATE( [IS Base_Consol], IS_Meta[AuditGroup] = "Depreciation" ),

    "General taxes",
        CALCULATE( [IS Base_Consol], IS_Meta[AuditGroup] = "General Taxes" ),

    "Net operating margins", [IS Operating Margin_Consol],

    "Other income, net",
        CALCULATE( [IS Base_Consol], IS_Meta[Section] = "Other Income" ),

    "Income tax expense (benefit)", [IS Income Tax_Consol],

    "Net margins", [IS Net Margins_Consol],

    // ---- Ratios ----
    "Net Margin Return on Average Net Telephone Plant", [FS_ReturnOnAvgNetPlant_Consol]
)




FS Value_Consol :=
IF (
    ISINSCOPE( FS_Meta[AuditGroup] ),
    SWITCH(
        SELECTEDVALUE( FS_Meta[AuditGroup] ),

        // ----- Balance Sheet Data -----
        "Property, plant and equipment",
            CALCULATE( [BS Display_Consol],
                BS_Meta[AuditGroup] IN {
                    "Telephone Plant in Service","Internet Plant in Service","Plant - Other","Plant Under Construction"
                }
            ),
        "Less accumulated depreciation",
            CALCULATE( [BS Display_Consol], BS_Meta[AuditGroup] = "Less Accumulated Depreciation" ),
        "Net property and equipment",           [FS_NetPPE_Consol],
        "Investments",
            CALCULATE( [BS Display_Consol],
                BS_Meta[AuditGroup] IN { "Equity Method Investments","Equity Investments" }
            ),
        "Current assets",
            CALCULATE( [BS Display_Consol], BS_Meta[Subsection] = "Current Assets" ),
        "Noncurrent assets",
            CALCULATE( [BS Display_Consol],
                BS_Meta[AuditGroup] IN { "Prepayments (Non Current)","Deferred Charges" }
            ),
        "Total assets",
            CALCULATE( [BS Display_Consol], BS_Meta[Section] = "Assets" ),
        "Less current liabilities",
            CALCULATE( [BS Display_Consol], BS_Meta[Subsection] = "Current Liabilities" ),
        "Less other long-term liabilities",
            CALCULATE( [BS Display_Consol], BS_Meta[Subsection] = "Other Noncurrent Liabilities" ),
        "Equity",
            CALCULATE( [BS Display_Consol], BS_Meta[Section] = "Members' Equity" ),

        // ----- Operating Data -----
        "Local network services",             CALCULATE( [IS Base_Consol], IS_Meta[AuditGroup] = "Local Network Services" ),
        "Network access services",            CALCULATE( [IS Base_Consol], IS_Meta[AuditGroup] = "Network Access Services" ),
        "Long distance services",             CALCULATE( [IS Base_Consol], IS_Meta[AuditGroup] = "Long Distance Services" ),
        "Internet, sales and other services", CALCULATE( [IS Base_Consol], IS_Meta[AuditGroup] = "Internet, Sales and Other Services" ),
        "Miscellaneous",                      CALCULATE( [IS Base_Consol], IS_Meta[AuditGroup] = "Miscellaneous Revenue" ),
        "Total operating revenues",           [IS Revenues_Consol],
        "Operating expenses",                 CALCULATE( [IS Base_Consol], IS_Meta[Section] = "Operating Expenses", IS_Meta[AuditGroup] <> "Depreciation", IS_Meta[AuditGroup] <> "General Taxes" ),
        "Depreciation and amortization",      CALCULATE( [IS Base_Consol], IS_Meta[AuditGroup] = "Depreciation" ),
        "General taxes",                      CALCULATE( [IS Base_Consol], IS_Meta[AuditGroup] = "General Taxes" ),
        "Net operating margins",              [IS Operating Margin_Consol],
        "Other income, net",                  CALCULATE( [IS Base_Consol], IS_Meta[Section] = "Other Income" ),
        "Income tax expense (benefit)",       [IS Income Tax_Consol],
        "Net margins",                        [IS Net Margins_Consol],

        // ----- Ratio -----
        "Net Margin Return on Average Net Telephone Plant", [FS_ReturnOnAvgNetPlant_Consol]
    ),
    BLANK()
)

